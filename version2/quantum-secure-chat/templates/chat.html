<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk'n'Go - {{ username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <h3>{{ username }}</h3>
                    <p class="user_port">{{ user_port }}</p>
                </div>
                <div class="header-buttons">
                    <a href="{{ url_for('quantum_dashboard') }}" class="status-btn" title="Quantum Security Dashboard">üîê Quantum</a>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchUsers" placeholder="Search users..." onkeyup="searchUsers()">
                <button onclick="searchUsers()">Search</button>
            </div>
            
            <div class="users-section">
                <h4>All Users</h4>
                <div id="usersList" class="users-list">
                    <div class="loading">Loading users...</div>
                </div>
            </div>
            
            <div class="friends-section">
                <h4>Online Users</h4>
                <div id="friendsList" class="friends-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header" id="chatHeader">
                <div class="no-chat-selected" id="noChatSelected">
                    <h3>Talk'n'Go</h3>
                    <p>Select a user from the sidebar to start chatting</p>
                </div>
                <div class="active-chat-header" id="activeChatHeader" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h3 id="activeChatUser">Friend Name</h3>
                            <p id="activeChatStatus">Online</p>
                        </div>
                        <div class="quantum-controls" id="quantumControls" style="display: none;">
                            <button id="enableQuantumBtn" class="quantum-btn" onclick="enableQuantumSecurity()" 
                                    title="Enable Quantum Encryption">üîì Enable Quantum</button>
                            <span id="quantumStatus" class="quantum-status" style="display: none;">üîê Quantum Secured</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="no-chat-message" id="noChatMessage">
                    <p>Your messages will appear here</p>
                </div>
                <div class="messages" id="messages" style="display: none;"></div>
            </div>
            
            <div class="message-input-container" id="messageInput" style="display: none;">
                <div class="input-group">
                    <!-- File upload buttons -->
                    <div class="file-buttons">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('imageInput').click()" class="file-btn" title="Send Image">
                            üì∑
                        </button>
                        <input type="file" id="fileInput" style="display: none;">
                        <button type="button" onclick="document.getElementById('fileInput').click()" class="file-btn" title="Send File">
                            üìé
                        </button>
                        <button type="button" id="quantumToggle" class="file-btn" title="Toggle Quantum Encryption" 
                                onclick="toggleQuantumEncryption()" style="background: #666;">üîì</button>
                    </div>
                    
                    <input type="text" id="messageText" placeholder="Type a message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div id="encryptionStatus" style="color: #25D366; font-size: 12px; margin-top: 5px; display: none;">
                    üîí Messages are quantum encrypted
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden elements for file uploads -->
    <div id="uploadProgress" style="display: none;">
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
        <span id="uploadStatus">Uploading...</span>
    </div>

    <!-- Quantum Security Notification -->
    <div id="quantumNotification" class="notification-banner" style="display: none;">
        <span id="quantumNotificationText"></span>
        <button class="notification-close" onclick="hideNotification()">√ó</button>
    </div>

    <script>
        // Global variables
        const currentUserPort = {{ user_port }};
        const currentUsername = "{{ username }}";
        let selectedUserPort = null;
        let selectedUsername = null;
        let messageInterval = null;
        let quantumEncryptionEnabled = false;
        let quantumSecurityEstablished = false;

        // Message loading and auto-refresh
        let lastMessageId = null;
        let isFirstLoad = true;

        console.log("üöÄ Quantum Secure Talk'n'Go initialized for:", currentUsername);

        // Load users when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üìÑ DOM loaded, starting user load...");
            loadUsers();
            setInterval(loadUsers, 3000);
            
            // Auto-focus message input when user is selected
            document.addEventListener('click', function(e) {
                if (e.target.closest('.user-item') || e.target.closest('.friend-item')) {
                    setTimeout(() => {
                        document.getElementById('messageText').focus();
                    }, 100);
                }
            });

            // Add Enter key listener
            document.getElementById('messageText').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });

            // Image upload handler
            document.getElementById('imageInput').addEventListener('change', function(e) {
                handleImageUpload(e.target.files[0]);
            });

            // File upload handler
            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0]);
            });
        });

        // QUANTUM SECURITY FUNCTIONS
        async function enableQuantumSecurity() {
            if (!selectedUserPort) return;
            
            showNotification("üîê Starting quantum key exchange...");
            
            try {
                const response = await fetch('/api/enable_quantum', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_port: selectedUserPort
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    quantumSecurityEstablished = true;
                    updateQuantumUI(true);
                    showNotification("‚úÖ Quantum secure channel established!");
                    
                    // Check quantum status
                    checkQuantumStatus();
                } else {
                    showNotification("‚ùå Quantum security setup failed");
                }
            } catch (error) {
                console.error('‚ùå Quantum security error:', error);
                showNotification("‚ùå Quantum security error");
            }
        }

        async function checkQuantumStatus() {
            if (!selectedUserPort) return;
            
            try {
                const response = await fetch(`/api/quantum_status?target_port=${selectedUserPort}`);
                const status = await response.json();
                
                quantumSecurityEstablished = status.secure_channel || false;
                updateQuantumUI(quantumSecurityEstablished);
                
            } catch (error) {
                console.error('‚ùå Quantum status check error:', error);
            }
        }

        function toggleQuantumEncryption() {
            if (!selectedUserPort) {
                showNotification("Please select a user first");
                return;
            }
            
            if (!quantumSecurityEstablished) {
                enableQuantumSecurity();
                return;
            }
            
            quantumEncryptionEnabled = !quantumEncryptionEnabled;
            updateEncryptionToggle();
            
            if (quantumEncryptionEnabled) {
                showNotification("üîí Quantum encryption enabled for this chat");
            } else {
                showNotification("üîì Quantum encryption disabled for this chat");
            }
        }

        function updateQuantumUI(isSecure) {
            const enableBtn = document.getElementById('enableQuantumBtn');
            const quantumStatus = document.getElementById('quantumStatus');
            const quantumControls = document.getElementById('quantumControls');
            
            quantumSecurityEstablished = isSecure;
            
            if (isSecure) {
                enableBtn.style.display = 'none';
                quantumStatus.style.display = 'inline';
                quantumControls.style.display = 'block';
                quantumEncryptionEnabled = true;
                updateEncryptionToggle();
            } else {
                enableBtn.style.display = 'inline';
                quantumStatus.style.display = 'none';
                quantumControls.style.display = 'block';
                quantumEncryptionEnabled = false;
                updateEncryptionToggle();
            }
        }

        function updateEncryptionToggle() {
            const quantumToggle = document.getElementById('quantumToggle');
            const encryptionStatus = document.getElementById('encryptionStatus');
            
            if (quantumEncryptionEnabled && quantumSecurityEstablished) {
                quantumToggle.style.background = '#25D366';
                quantumToggle.innerHTML = 'üîí';
                quantumToggle.title = 'Quantum Encryption: ON';
                encryptionStatus.style.display = 'block';
            } else {
                quantumToggle.style.background = '#666';
                quantumToggle.innerHTML = 'üîì';
                quantumToggle.title = 'Quantum Encryption: OFF';
                encryptionStatus.style.display = 'none';
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('quantumNotification');
            const notificationText = document.getElementById('quantumNotificationText');
            
            notificationText.textContent = message;
            notification.style.display = 'flex';
            
            // Auto-hide after 5 seconds
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('quantumNotification');
            notification.style.display = 'none';
        }

        // Enhanced user list with quantum status
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const users = await response.json();
                updateUserLists(users);
                
            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                document.getElementById('usersList').innerHTML = '<div class="error">Error loading users</div>';
                document.getElementById('friendsList').innerHTML = '<div class="error">Error loading users</div>';
            }
        }

        // Update user lists with quantum security indicators
        function updateUserLists(users) {
            const usersList = document.getElementById('usersList');
            const friendsList = document.getElementById('friendsList');
            
            // Update All Users list
            if (Object.keys(users).length === 0) {
                usersList.innerHTML = '<div class="no-users">No other users found</div>';
                friendsList.innerHTML = '<div class="no-users">No online users</div>';
                return;
            }
            
            usersList.innerHTML = '';
            Object.entries(users).forEach(([port, user]) => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.onclick = () => selectUser(port, user.username);
                
                const quantumIndicator = user.quantum_secure ? ' <span style="color: #25D366; font-size: 12px;">üîí</span>' : '';
                
                userItem.innerHTML = `
                    <div class="user-info-small">
                        <div class="user-name">${user.username}${quantumIndicator}</div>
                    </div>
                    <span class="user-status ${user.online ? 'status-online' : 'status-offline'}">
                        ${user.online ? 'Online' : 'Offline'}
                    </span>
                `;
                usersList.appendChild(userItem);
            });
            
            // Update Online Users list
            friendsList.innerHTML = '';
            const onlineUsers = Object.entries(users).filter(([port, user]) => user.online);
            
            if (onlineUsers.length === 0) {
                friendsList.innerHTML = '<div class="no-users">No online users</div>';
                return;
            }
            
            onlineUsers.forEach(([port, user]) => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.onclick = () => selectUser(port, user.username);
                
                const quantumIndicator = user.quantum_secure ? ' <span style="color: #25D366; font-size: 12px;">üîí</span>' : '';
                
                friendItem.innerHTML = `
                    <div class="user-info-small">
                        <div class="user-name">${user.username}${quantumIndicator}</div>
                    </div>
                    <span class="user-status status-online">Online</span>
                `;
                friendsList.appendChild(friendItem);
            });
        }

        // Enhanced select user with quantum status check
        async function selectUser(port, username) {
            console.log("üë§ Selecting user:", username);
            
            selectedUserPort = port;
            selectedUsername = username;
            
            // Reset message tracking for new conversation
            lastMessageId = null;
            isFirstLoad = true;
            
            // Update UI
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('activeChatHeader').style.display = 'block';
            document.getElementById('activeChatUser').textContent = username;
            document.getElementById('activeChatStatus').textContent = 'Online';
            document.getElementById('messages').style.display = 'flex';
            document.getElementById('messageInput').style.display = 'block';
            document.getElementById('noChatMessage').style.display = 'none';
            
            // Show quantum controls
            document.getElementById('quantumControls').style.display = 'block';
            
            // Check quantum security status
            await checkQuantumStatus();
            
            // Auto-focus message input
            setTimeout(() => {
                document.getElementById('messageText').focus();
            }, 100);
            
            // Clear previous interval
            if (messageInterval) {
                clearInterval(messageInterval);
            }
            
            // Load messages and start polling
            await loadMessages();
            messageInterval = setInterval(loadMessages, 2000);
        }

        // Enhanced message loading with incremental updates
        async function loadMessages() {
            if (!selectedUserPort) return;
            
            try {
                let url = `/api/messages/${selectedUserPort}`;
                
                // After first load, use incremental loading
                if (!isFirstLoad && lastMessageId) {
                    url = `/api/messages/${selectedUserPort}/new`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }
                const messages = await response.json();
                const messagesContainer = document.getElementById('messages');
                
                if (isFirstLoad) {
                    // First load - show all messages
                    messagesContainer.innerHTML = '';
                    if (messages.length === 0) {
                        messagesContainer.innerHTML = '<div class="no-messages">No messages yet. Start the conversation!</div>';
                        isFirstLoad = false;
                        return;
                    }
                    
                    // Sort messages by timestamp
                    messages.sort((a, b) => {
                        const timeA = new Date(`${a.date} ${a.timestamp}`);
                        const timeB = new Date(`${b.date} ${b.timestamp}`);
                        return timeA - timeB;
                    });
                    
                    messages.forEach(msg => {
                        addMessageToChat(msg);
                    });
                    
                    // Store the last message ID for incremental loading
                    if (messages.length > 0) {
                        lastMessageId = messages[messages.length - 1].id;
                    }
                    isFirstLoad = false;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    // Incremental load - only add new messages
                    if (messages.length > 0) {
                        messages.forEach(msg => {
                            addMessageToChat(msg);
                        });
                        
                        // Update last message ID
                        lastMessageId = messages[messages.length - 1].id;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
            }
        }

        // Helper function to add a single message to chat
        function addMessageToChat(msg) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const isSent = parseInt(msg.from_port) === parseInt(currentUserPort);
            messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'} ${msg.type}-message`;
            
            // Add quantum encryption indicator
            const quantumIndicator = msg.quantum_encrypted ? ' <span style="color: #25D366; font-size: 10px;">üîí</span>' : '';
            
            let messageContent = '';
            
            if (msg.type === 'text') {
                messageContent = `
                    <div class="message-text">${msg.message}${quantumIndicator}</div>
                    <div class="message-time">${msg.timestamp}</div>
                `;
            } else if (msg.type === 'encrypted_text') {
                // Handle encrypted messages
                const displayText = msg.display_message || msg.message;
                messageContent = `
                    <div class="message-text">${displayText}${quantumIndicator}</div>
                    <div class="message-time">${msg.timestamp}</div>
                `;
            } else if (msg.type === 'image') {
                const imageUrl = `/file/image/${msg.file_path}`;
                messageContent = `
                    <div class="file-message">
                        <div class="file-info">
                            <span class="file-icon">üñºÔ∏è</span>
                            <span class="file-name">Image${quantumIndicator}</span>
                        </div>
                        <img src="${imageUrl}" alt="Shared image" class="message-image" onclick="openImage('${imageUrl}')">
                        <div class="message-time">${msg.timestamp}</div>
                    </div>
                `;
            } else if (msg.type === 'file') {
                const fileUrl = `/file/file/${msg.file_path}`;
                messageContent = `
                    <div class="file-message">
                        <div class="file-info">
                            <span class="file-icon">üìé</span>
                            <div class="file-details">
                                <div class="file-name">${msg.message}${quantumIndicator}</div>
                                <div class="file-size">${formatFileSize(msg.file_size)}</div>
                            </div>
                        </div>
                        <a href="${fileUrl}" download="${msg.message}" class="download-btn">Download</a>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
        }

        // Enhanced send message with quantum encryption
        async function sendMessage() {
            if (!selectedUserPort) {
                alert('Please select a user first!');
                return;
            }
            
            const messageText = document.getElementById('messageText');
            const text = messageText.value.trim();
            
            if (!text) return;
            
            try {
                const useQuantum = quantumEncryptionEnabled && quantumSecurityEstablished;
                
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to_port: selectedUserPort,
                        message: text,
                        type: 'text',
                        use_quantum: useQuantum
                    })
                });
                
                const result = await response.json();
                if (result.status === 'sent') {
                    messageText.value = '';
                    // Force reload all messages to ensure we see our sent message
                    isFirstLoad = true;
                    await loadMessages();
                    
                    if (useQuantum) {
                        showNotification("üîí Message sent with quantum encryption");
                    }
                } else {
                    alert('Failed to send message: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                alert('Error sending message');
            }
        }

        function openImage(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function handleImageUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('Image size should be less than 10MB');
                return;
            }

            showUploadProgress('Uploading image...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                sendFileMessage(file.name, base64, 'image', file.size);
                hideUploadProgress();
            };
            reader.onerror = function() {
                alert('Error reading image file');
                hideUploadProgress();
            };
            reader.readAsDataURL(file);
        }

        function handleFileUpload(file) {
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (file.size > 15 * 1024 * 1024) {
                alert('File size should be less than 15MB');
                return;
            }

            showUploadProgress('Uploading file...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1];
                sendFileMessage(file.name, base64, 'file', file.size);
                hideUploadProgress();
            };
            reader.onerror = function() {
                alert('Error reading file');
                hideUploadProgress();
            };
            reader.readAsDataURL(file);
        }

        async function sendFileMessage(fileName, fileData, fileType, fileSize) {
            if (!selectedUserPort) {
                alert('Please select a user first!');
                return;
            }

            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to_port: selectedUserPort,
                        message: fileName,
                        type: fileType,
                        file_data: fileData,
                        file_name: fileName,
                        file_size: fileSize,
                        use_quantum: quantumEncryptionEnabled && quantumSecurityEstablished
                    })
                });
                
                const result = await response.json();
                if (result.status === 'sent') {
                    // Force reload to show the new file message
                    isFirstLoad = true;
                    await loadMessages();
                } else {
                    alert('Failed to send file: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('‚ùå Error sending file:', error);
                alert('Error sending file');
            }
        }

        function showUploadProgress(message) {
            const progress = document.getElementById('uploadProgress');
            const status = document.getElementById('uploadStatus');
            status.textContent = message;
            progress.style.display = 'block';
        }

        function hideUploadProgress() {
            const progress = document.getElementById('uploadProgress');
            progress.style.display = 'none';
            document.getElementById('imageInput').value = '';
            document.getElementById('fileInput').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            const friendItems = document.querySelectorAll('.friend-item');
            
            userItems.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                if (userName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            friendItems.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                if (userName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function sendHeartbeat() {
            try {
                await fetch('/api/heartbeat');
            } catch (error) {
                console.log('Heartbeat failed');
            }
        }

        setInterval(sendHeartbeat, 10000);
    </script>
</body>
</html>
